stages:
- build
- test
- release
- deploy

include: 'https://git.dbogatov.org/templates/ci-snippets/raw/master/trigger-websites-deploy.yml'

build-binaries:
  image: dbogatov/docker-images:pbc-latest
  stage: build
  script:
  - cd ./max-flow
  - make binaries
  artifacts:
    expire_in: 30 min
    paths:
    - ./max-flow/main
    - ./max-flow/test-max-flow
  tags:
  - docker

build-docs:
  image: dbogatov/docker-images:doxygen-latest
  stage: build
  script:
  - cd ./max-flow
  - doxygen ../Doxyfile
  artifacts:
    expire_in: 30 min
    paths:
    - ./docs
    - Dockerfile
    - nginx.conf
  tags:
  - docker

test:
  image: dbogatov/docker-images:pbc-latest
  stage: test
  script:
  - cd ./max-flow/
  - make main
  - ./main
  - make coverage
  dependencies:
    - build-binaries
  artifacts:
    expire_in: 1 day
    paths:
      - ./max-flow/coverage-html/
  tags:
  - docker

docs-website:
  variables:
    GIT_STRATEGY: none
  stage: release
  script:
  - docker build -t registry.dbogatov.org/bu/deduplication-project/max-flow:$CI_BUILD_REF_NAME .
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.dbogatov.org
  - docker push registry.dbogatov.org/bu/deduplication-project/max-flow:$CI_BUILD_REF_NAME
  dependencies:
  - build-docs
  tags:
  - shell
  only:
  - master

pages:
  image: dbogatov/docker-images:alpine-extras-latest
  variables:
    GIT_STRATEGY: none
  stage: release
  script:
  - mv docs/html public/
  - echo "Uploading files to pages"
  artifacts:
    expire_in: 30 min
    paths:
    - public
  dependencies:
  - build-docs
  tags:
  - docker
  only:
  - master
